<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>jää — SQL Terminal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #060a10;
    --surface: #0b1018;
    --surface2: #111a26;
    --border: #486676;
    --border-focus: #5ab4d6;
    --text: #b8c8d8;
    --text-dim: #708a9e;
    --text-bright: #dce8f0;
    --accent: #4da8cc;
    --accent-dim: #4888a8;
    --ice: #8ad4ef;
    --ice-dim: #3a7a9a;
    --success: #5aeac4;
    --error: #f07070;
    --warning: #e8c86a;
    --font-mono: 'DM Mono', 'Menlo', monospace;
    --font-serif: 'Instrument Serif', Georgia, serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 13px;
    line-height: 1.6;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    padding: 20px 32px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: baseline;
    gap: 16px;
    background: linear-gradient(180deg, #080e16 0%, var(--bg) 100%);
  }

  header h1 {
    font-family: var(--font-serif);
    font-size: 26px;
    font-weight: 400;
    color: var(--text-bright);
    letter-spacing: -0.02em;
  }

  header h1 span {
    color: var(--ice);
    font-style: italic;
  }

  header .tag {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-dim);
    background: var(--surface2);
    padding: 3px 8px;
    border-radius: 3px;
    border: 1px solid var(--border);
  }

  .status-bar {
    margin-left: auto;
    display: flex;
    gap: 16px;
    font-size: 11px;
    color: var(--text-dim);
  }

  .status-bar .dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--success);
    margin-right: 6px;
    vertical-align: middle;
    animation: pulse 3s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  main {
    flex: 1;
    display: grid;
    grid-template-columns: 260px 1fr;
    grid-template-rows: 1fr auto;
    overflow: hidden;
  }

  .sidebar {
    grid-row: 1 / 3;
    border-right: 1px solid var(--border);
    background: var(--surface);
    overflow-y: auto;
    padding: 16px 0;
  }

  .sidebar h3 {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--text-dim);
    padding: 8px 16px 6px;
    font-weight: 500;
  }

  .sidebar .table-item {
    padding: 6px 16px 6px 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.15s;
    color: var(--text);
    font-size: 12px;
  }

  .sidebar .table-item:hover { background: var(--surface2); }
  .sidebar .table-item .icon { color: var(--ice-dim); font-size: 11px; }

  .sidebar .column-item {
    padding: 3px 16px 3px 44px;
    font-size: 11px;
    color: var(--text-dim);
    display: flex;
    gap: 6px;
  }

  .sidebar .column-item .type {
    color: var(--accent-dim);
    font-size: 10px;
  }

  .sidebar .empty-msg {
    padding: 20px 16px;
    color: var(--text-dim);
    font-size: 11px;
    font-style: italic;
  }

  .sidebar .example-section {
    border-top: 1px solid var(--border);
    margin-top: 12px;
    padding-top: 4px;
  }

  .sidebar .example-item {
    padding: 5px 16px 5px 24px;
    cursor: pointer;
    font-size: 11px;
    color: var(--text-dim);
    transition: all 0.15s;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .sidebar .example-item:hover {
    background: var(--surface2);
    color: var(--ice);
  }

  .output-area {
    overflow-y: auto;
    padding: 0;
    display: flex;
    flex-direction: column;
  }

  .output-entry {
    border-bottom: 1px solid var(--border);
    animation: fadeIn 0.2s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .output-entry .sql-echo {
    padding: 10px 20px 6px;
    font-size: 12px;
    color: var(--ice);
    display: flex;
    align-items: baseline;
    gap: 8px;
  }

  .output-entry .sql-echo .prompt { color: var(--text-dim); }
  .output-entry .sql-echo .timing {
    margin-left: auto;
    font-size: 10px;
    color: var(--text-dim);
    flex-shrink: 0;
  }

  .output-entry .result-table-wrap {
    padding: 0 20px 12px;
    overflow-x: auto;
  }

  .output-entry table {
    border-collapse: collapse;
    font-size: 12px;
    width: 100%;
    max-width: 100%;
  }

  .output-entry th {
    text-align: left;
    padding: 6px 12px;
    border-bottom: 2px solid var(--border);
    color: var(--text-dim);
    font-weight: 500;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    white-space: nowrap;
  }

  .output-entry td {
    padding: 5px 12px;
    border-bottom: 1px solid #48667640;
    white-space: nowrap;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .output-entry tr:hover td { background: var(--surface); }
  .output-entry td.null-val { color: var(--text-dim); font-style: italic; }
  .output-entry td.num-val { color: var(--warning); font-variant-numeric: tabular-nums; }
  .output-entry td.bool-val { color: var(--accent); }

  .output-entry .message {
    padding: 6px 20px 12px;
    font-size: 12px;
  }

  .output-entry .message.ok { color: var(--success); }
  .output-entry .message.err { color: var(--error); }
  .output-entry .message .row-count {
    color: var(--text-dim);
    font-size: 11px;
  }

  .welcome {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    color: var(--text-dim);
    padding: 40px;
  }

  .welcome .logo {
    font-family: var(--font-serif);
    font-size: 48px;
    color: var(--ice);
    font-style: italic;
    opacity: 0.3;
    letter-spacing: -0.03em;
  }

  .welcome p { font-size: 12px; text-align: center; max-width: 400px; line-height: 1.7; }
  .welcome kbd {
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 11px;
  }

  .input-area {
    border-top: 1px solid var(--border);
    background: var(--surface);
    padding: 12px 20px;
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }

  .input-area .prompt-label {
    color: var(--accent);
    font-size: 13px;
    padding: 7px 0;
    flex-shrink: 0;
    font-weight: 500;
  }

  .input-area textarea {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text-bright);
    font-family: var(--font-mono);
    font-size: 13px;
    padding: 8px 12px;
    resize: none;
    outline: none;
    line-height: 1.5;
    min-height: 36px;
    max-height: 200px;
    transition: border-color 0.2s;
  }

  .input-area textarea:focus { border-color: var(--border-focus); }
  .input-area textarea::placeholder { color: var(--text-dim); }

  .input-area button {
    background: var(--accent);
    border: none;
    color: var(--bg);
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 500;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    transition: all 0.15s;
    flex-shrink: 0;
  }

  .input-area button:hover { background: #5dbde0; }
  .input-area button:active { transform: scale(0.97); }
  .input-area button:disabled { opacity: 0.4; cursor: not-allowed; }

  /* ── Debug Toggle ─────────────────────── */
  .debug-toggle {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-family: var(--font-mono);
    font-size: 10px;
    padding: 3px 10px;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 0.04em;
  }

  .debug-toggle:hover { color: var(--ice); border-color: var(--ice-dim); }
  .debug-toggle.active { color: var(--ice); border-color: var(--ice); background: var(--surface); }

  /* ── Debug Panel ────────────────────────── */
  .debug-panel {
    position: fixed;
    top: 0;
    right: -420px;
    width: 420px;
    height: 100vh;
    background: var(--surface);
    border-left: 1px solid var(--border);
    z-index: 100;
    display: flex;
    flex-direction: column;
    transition: right 0.25s ease;
    box-shadow: -4px 0 24px rgba(0,0,0,0.4);
  }

  .debug-panel.open { right: 0; }

  .debug-header {
    padding: 16px 16px 12px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  .debug-header h3 {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-dim);
    font-weight: 500;
  }

  .debug-close {
    background: none;
    border: none;
    color: var(--text-dim);
    font-size: 16px;
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 3px;
    transition: all 0.15s;
  }

  .debug-close:hover { color: var(--text-bright); background: var(--surface2); }

  .debug-stats {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 16px;
    font-size: 10px;
    color: var(--text-dim);
    flex-shrink: 0;
  }

  .debug-stats .stat-val { color: var(--ice); font-weight: 500; }

  .debug-php {
    flex-shrink: 0;
  }

  .debug-php .php-error {
    padding: 6px 16px;
    font-size: 11px;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 8px;
    align-items: baseline;
  }

  .debug-php .php-level {
    font-size: 9px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    padding: 1px 5px;
    border-radius: 2px;
    flex-shrink: 0;
  }

  .debug-php .php-level.WARNING { background: #e8c86a22; color: var(--warning); }
  .debug-php .php-level.NOTICE { background: #4da8cc22; color: var(--accent); }
  .debug-php .php-level.ERROR { background: #f0707022; color: var(--error); }

  .debug-php .php-msg { color: var(--text); word-break: break-word; }
  .debug-php .php-loc { color: var(--text-dim); font-size: 10px; flex-shrink: 0; }

  .debug-stream {
    flex: 1;
    overflow-y: auto;
    padding: 0;
  }

  .debug-stream .empty-msg {
    padding: 20px 16px;
    color: var(--text-dim);
    font-size: 11px;
    font-style: italic;
  }

  .stream-entry {
    padding: 4px 16px 4px 12px;
    font-size: 11px;
    display: flex;
    align-items: baseline;
    gap: 6px;
    border-bottom: 1px solid #48667618;
    transition: background 0.1s;
  }

  .stream-entry:hover { background: var(--surface2); }

  .stream-entry .seq {
    color: var(--text-dim);
    font-size: 9px;
    width: 22px;
    text-align: right;
    flex-shrink: 0;
    font-variant-numeric: tabular-nums;
  }

  .stream-entry .arrow {
    flex-shrink: 0;
    font-size: 10px;
  }

  .stream-entry .arrow.claimed { color: var(--success); }
  .stream-entry .arrow.pending { color: var(--warning); }

  .stream-entry .ev-type {
    font-weight: 500;
    flex-shrink: 0;
  }

  .stream-entry .ev-type.claimed { color: var(--ice); }
  .stream-entry .ev-type.pending { color: var(--warning); }

  .stream-entry .gate-name {
    color: var(--accent-dim);
    font-size: 10px;
    flex-shrink: 0;
  }

  .stream-entry .ev-data {
    color: var(--text-dim);
    font-size: 10px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 200px;
    cursor: default;
  }

  .stream-entry .ev-data.expanded {
    white-space: pre-wrap;
    max-width: none;
    word-break: break-all;
  }

  @media (max-width: 700px) {
    main { grid-template-columns: 1fr; }
    .sidebar { display: none; }
    .debug-panel { width: 100vw; right: -100vw; }
  }
</style>
</head>
<body>

<header>
  <h1>jää <span>db</span></h1>
  <div class="tag">Phase 20 &bull; persistent &bull; PHP 8.3</div>
  <div class="status-bar">
    <span><span class="dot"></span>Engine running</span>
    <button class="debug-toggle" id="debug-toggle" onclick="toggleDebug()" title="Stream log &amp; PHP debug">⚙ Debug</button>
  </div>
</header>

<main>
  <aside class="sidebar" id="sidebar">
    <h3>Schema</h3>
    <div id="schema-list"><div class="empty-msg">No tables yet</div></div>
    <div class="example-section">
      <h3>Quick Start</h3>
      <div class="example-item" data-sql="CREATE TABLE users (id INTEGER NOT NULL, name TEXT, age INTEGER, dept TEXT DEFAULT 'general')">CREATE TABLE users …</div>
      <div class="example-item" data-sql="INSERT INTO users (name, age, dept) VALUES ('Alice', 30, 'eng')">INSERT Alice</div>
      <div class="example-item" data-sql="INSERT INTO users (name, age, dept) VALUES ('Bob', 25, 'sales')">INSERT Bob</div>
      <div class="example-item" data-sql="INSERT INTO users (name, age, dept) VALUES ('Carol', 35, 'eng')">INSERT Carol</div>
      <div class="example-item" data-sql="INSERT INTO users (name, age, dept) VALUES ('Dave', NULL, 'sales')">INSERT Dave (null age)</div>
      <div class="example-item" data-sql="SELECT * FROM users">SELECT * FROM users</div>
      <div class="example-item" data-sql="SELECT * FROM users WHERE age > 28 ORDER BY age DESC">WHERE … ORDER BY</div>
      <div class="example-item" data-sql="SELECT dept, COUNT(*) AS cnt, AVG(age) AS avg_age FROM users GROUP BY dept">GROUP BY + aggregates</div>
    </div>
    <div class="example-section">
      <h3>Advanced</h3>
      <div class="example-item" data-sql="SELECT DISTINCT dept FROM users ORDER BY dept">DISTINCT</div>
      <div class="example-item" data-sql="SELECT * FROM users ORDER BY age ASC NULLS LAST">NULLS LAST</div>
      <div class="example-item" data-sql="INSERT INTO users (name, age, dept) VALUES ('Eve', 20 + 8, UPPER('eng'))">INSERT with expressions</div>
      <div class="example-item" data-sql="SELECT name, CASE WHEN age > 30 THEN 'senior' WHEN age > 25 THEN 'mid' ELSE 'junior' END AS level FROM users WHERE age IS NOT NULL">CASE WHEN</div>
      <div class="example-item" data-sql="SELECT name, age, SUM(age) OVER (ORDER BY age) AS running FROM users WHERE age IS NOT NULL">Window function</div>
      <div class="example-item" data-sql="SELECT * FROM users WHERE age > (SELECT AVG(age) FROM users WHERE age IS NOT NULL)">Subquery</div>
      <div class="example-item" data-sql="WITH RECURSIVE cnt(x) AS (SELECT 1 UNION ALL SELECT x + 1 FROM cnt WHERE x < 10) SELECT x FROM cnt">Recursive CTE</div>
      <div class="example-item" data-sql="UPDATE users SET age = 31 WHERE name = 'Alice'">UPDATE</div>
      <div class="example-item" data-sql="DELETE FROM users WHERE name = 'Bob'">DELETE</div>
      <div class="example-item" data-sql="CREATE INDEX idx_dept ON users(dept)">CREATE INDEX</div>
    </div>
  </aside>

  <div class="output-area" id="output">
    <div class="welcome">
      <div class="logo">jää</div>
      <p>Event-driven database engine with persistent storage.<br>
      Stateless gates. Content-addressed storage. Pure transforms.<br><br>
      Type SQL below or click an example.<br>
      <kbd>Enter</kbd> to execute, <kbd>Shift+Enter</kbd> for newline, <kbd>↑</kbd><kbd>↓</kbd> for history.</p>
    </div>
  </div>

  <div class="input-area">
    <span class="prompt-label">sql&gt;</span>
    <textarea id="input" rows="1" placeholder="SELECT * FROM ..." autofocus></textarea>
    <button id="run-btn" onclick="executeSql()">Run</button>
  </div>

  <!-- Debug Panel -->
  <aside class="debug-panel" id="debug-panel">
    <div class="debug-header">
      <h3>Stream Log</h3>
      <button class="debug-close" onclick="toggleDebug()">✕</button>
    </div>
    <div class="debug-stats" id="debug-stats"></div>
    <div class="debug-php" id="debug-php"></div>
    <div class="debug-stream" id="debug-stream">
      <div class="empty-msg">Run a query to see the event flow</div>
    </div>
  </aside>
</main>

<script>
// ── Debug Panel ─────────────────────────
let debugOpen = false;

function toggleDebug() {
  debugOpen = !debugOpen;
  document.getElementById('debug-panel').classList.toggle('open', debugOpen);
  document.getElementById('debug-toggle').classList.toggle('active', debugOpen);
}

function renderDebug(debug) {
  if (!debug) return;

  // Stats
  const stats = document.getElementById('debug-stats');
  const evCount = debug.stream ? debug.stream.length : 0;
  const claimed = debug.stream ? debug.stream.filter(e => e.claimed).length : 0;
  const pending = evCount - claimed;
  stats.innerHTML = `
    <span>Events: <span class="stat-val">${evCount}</span></span>
    <span>Claimed: <span class="stat-val">${claimed}</span></span>
    <span>Pending: <span class="stat-val">${pending}</span></span>
    <span>Memory: <span class="stat-val">${debug.memory}KB</span></span>
    <span>Time: <span class="stat-val">${debug.time}ms</span></span>`;

  // PHP errors
  const phpEl = document.getElementById('debug-php');
  if (debug.php && debug.php.length > 0) {
    phpEl.innerHTML = debug.php.map(e => `
      <div class="php-error">
        <span class="php-level ${e.level}">${e.level}</span>
        <span class="php-msg">${esc(e.message)}</span>
        <span class="php-loc">${esc(e.file)}:${e.line}</span>
      </div>`).join('');
  } else {
    phpEl.innerHTML = '';
  }

  // Stream log
  const streamEl = document.getElementById('debug-stream');
  if (!debug.stream || debug.stream.length === 0) {
    streamEl.innerHTML = '<div class="empty-msg">No events recorded</div>';
    return;
  }

  streamEl.innerHTML = debug.stream.map(entry => {
    const isClaimed = entry.claimed !== null;
    const arrowClass = isClaimed ? 'claimed' : 'pending';
    const arrow = isClaimed ? '→' : '◦';
    const typeClass = isClaimed ? 'claimed' : 'pending';
    const gate = isClaimed ? `<span class="gate-name">⤷ ${esc(entry.claimed)}</span>` : '';
    const dataStr = entry.data ? JSON.stringify(entry.data) : '';
    const dataSnippet = dataStr.length > 80 ? dataStr.substring(0, 80) + '…' : dataStr;
    const dataEl = dataStr
      ? `<span class="ev-data" title="${esc(dataStr)}" onclick="this.classList.toggle('expanded')">${esc(dataSnippet)}</span>`
      : '';

    return `<div class="stream-entry">
      <span class="seq">${entry.seq}</span>
      <span class="arrow ${arrowClass}">${arrow}</span>
      <span class="ev-type ${typeClass}">${esc(entry.type)}</span>
      ${gate}
      ${dataEl}
    </div>`;
  }).join('');

  streamEl.scrollTop = 0;
}

const API = 'api.php';
const history = [];
let historyPos = -1;
let running = false;

async function executeSql(override) {
  const input = document.getElementById('input');
  const btn = document.getElementById('run-btn');
  const sql = (override || input.value).trim();
  if (!sql || running) return;

  if (!override) {
    history.push(sql);
    historyPos = history.length;
    input.value = '';
    autoResize(input);
  }

  const welcome = document.querySelector('.welcome');
  if (welcome) welcome.remove();

  running = true;
  btn.disabled = true;
  btn.textContent = '…';

  const t0 = performance.now();

  try {
    const res = await fetch(API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sql }),
    });
    const data = await res.json();
    const clientMs = performance.now() - t0;
    const serverMs = data.elapsed ?? 0;
    const timing = `${serverMs.toFixed(1)}ms server · ${clientMs.toFixed(0)}ms total`;

    if (data.error) {
      appendError(sql, data.error, timing);
    } else if (data.rows !== undefined) {
      appendTable(sql, data.rows, timing);
    } else {
      appendMessage(sql, data.message || 'OK', 'ok', timing);
    }

    renderDebug(data.debug);
  } catch (e) {
    appendError(sql, 'Network error: ' + e.message, '');
  }

  running = false;
  btn.disabled = false;
  btn.textContent = 'Run';
  refreshSchema();
}

function appendTable(sql, rows, timing) {
  const out = document.getElementById('output');
  const entry = document.createElement('div');
  entry.className = 'output-entry';

  let html = `<div class="sql-echo"><span class="prompt">▸</span> ${esc(sql)} <span class="timing">${timing}</span></div>`;

  if (rows.length === 0) {
    html += '<div class="message ok"><span class="row-count">(0 rows)</span></div>';
  } else {
    const cols = Object.keys(rows[0]);
    html += '<div class="result-table-wrap"><table><thead><tr>';
    for (const c of cols) html += `<th>${esc(c)}</th>`;
    html += '</tr></thead><tbody>';
    for (const row of rows) {
      html += '<tr>';
      for (const c of cols) {
        const v = row[c];
        if (v === null || v === undefined) html += '<td class="null-val">null</td>';
        else if (typeof v === 'number') html += `<td class="num-val">${v}</td>`;
        else if (typeof v === 'boolean') html += `<td class="bool-val">${v}</td>`;
        else html += `<td>${esc(String(v))}</td>`;
      }
      html += '</tr>';
    }
    html += '</tbody></table></div>';
    html += `<div class="message ok"><span class="row-count">(${rows.length} row${rows.length !== 1 ? 's' : ''})</span></div>`;
  }

  entry.innerHTML = html;
  out.appendChild(entry);
  out.scrollTop = out.scrollHeight;
}

function appendMessage(sql, msg, type, timing) {
  const out = document.getElementById('output');
  const entry = document.createElement('div');
  entry.className = 'output-entry';
  entry.innerHTML = `
    <div class="sql-echo"><span class="prompt">▸</span> ${esc(sql)} <span class="timing">${timing}</span></div>
    <div class="message ${type}">${esc(msg)}</div>`;
  out.appendChild(entry);
  out.scrollTop = out.scrollHeight;
}

function appendError(sql, msg, timing) {
  appendMessage(sql, 'ERROR: ' + msg, 'err', timing);
}

function esc(s) {
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

async function refreshSchema() {
  try {
    const res = await fetch(API + '?schema=1');
    const data = await res.json();
    const list = document.getElementById('schema-list');

    if (!data.schema || data.schema.length === 0) {
      list.innerHTML = '<div class="empty-msg">No tables yet</div>';
      return;
    }

    let html = '';
    for (const t of data.schema) {
      html += `<div class="table-item" onclick="executeSql('SELECT * FROM ${t.table}')"><span class="icon">◇</span> ${esc(t.table)}</div>`;
      for (const col of t.columns) {
        html += `<div class="column-item">${esc(col.name)} <span class="type">${col.type || ''}</span></div>`;
      }
    }
    list.innerHTML = html;
  } catch (e) {
    // silent — sidebar just won't update
  }
}

// ── Input ──────────────────────────────
const input = document.getElementById('input');

input.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    executeSql();
  }
  if (e.key === 'ArrowUp' && input.value === '') {
    if (historyPos > 0) {
      historyPos--;
      input.value = history[historyPos];
      autoResize(input);
    }
  }
  if (e.key === 'ArrowDown' && historyPos >= 0) {
    if (historyPos < history.length - 1) {
      historyPos++;
      input.value = history[historyPos];
    } else {
      historyPos = history.length;
      input.value = '';
    }
    autoResize(input);
  }
});

input.addEventListener('input', () => autoResize(input));

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 200) + 'px';
}

document.querySelectorAll('.example-item').forEach(el => {
  el.addEventListener('click', () => {
    input.value = el.dataset.sql;
    autoResize(input);
    input.focus();
  });
});

// Load schema on page load (picks up persisted tables)
refreshSchema();
</script>
</body>
</html>
